//---------------------------------------------------------------------------

#include <fmx.h>
#pragma hdrstop

#include "Unit1.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
//#pragma link "DBAccess"
//#pragma link "MyAccess"
//#pragma link "MemDS"
#pragma resource "*.fmx"
TForm1 *Form1;


//---------------------------------------------------------------------------
__fastcall TForm1::TForm1(TComponent* Owner)
	: TForm(Owner)
{
Form1->FullScreen = true;
Form1->Top = 0;
Form1->Left=0;
PanelIsPressed = false;
InsertLog = false;
//Form1->Transparency = true;
//Form1->Width = 3000;
//Form1->Height = 1030;
//MediaPlayerControl1->Parent = Form1;
//MediaPlayer1->Play();
}
//---------------------------------------------------------------------------

void __fastcall TForm1::FormCreate(TObject *Sender)
{

//IdFTP1->Connect();
//if (IdFTP1->Connected()) {
  //	IdFTP1->ChangeDir("test");
  //	TStream* str;
  //	IdFTP1->Put("autorun.msc","22.txt");
	//IdFTP1->Get("1.php",str);
 //	}

Panel1->Visible = false;

//TByteDynArray A;
//A.set_length(5); A[0] = 'p'; A[1] = 'a'; A[2] = 'u'; A[3] = 's'; A[4] = 'e';
//IdUDPClient1->SendBuffer(A);

CMD = new TCommandQueue;
MC = new TMainControl(false,CMD);

TCommandQueue* UICommands = new TCommandQueue;
MC->UICommands = UICommands;
Images = new TImage*[55];
ImagesShadow = new TImage*[55];
ImagesFrame = new TImage*[55];
ItemLabels = new TLabel*[55];
Labels = new TLabel*[55];

MainLabel = new TLabel(Form1);
MotionsX = new TAxisMotion[55];
MotionsY = new TAxisMotion[55];
LastX = new double[55];
LastY = new double[55];
for (int i=0; i < 55; i++) {
	Images[i] = new TImage(Form1);
	ImagesShadow[i] = new TImage(Form1);
	ImagesFrame[i] = new TImage(Form1);
	ItemLabels[i] = new TLabel(Form1);
	Images[i]->Parent = Form1;
	ImagesShadow[i]->Parent = Form1;
	ImagesFrame[i]->Parent = Form1;
	ItemLabels[i]->Parent = Form1;
	Labels[i] = new TLabel(Form1);
	Labels[i]->Parent = Form1;
	MotionsX[i].SetImmediateTarget(0,0,false);
	MotionsY[i].SetImmediateTarget(0,0,false);
	}
MainLabel->Parent = Form1;
MC->Commands->CreateCommand("Script.LoadScript,\"autorun.msc\",0,1");

//Image1->Bitmap->LoadFromFile("wall2.jpg");
//BackImage->Bitmap->LoadFromFile("black.png");
//BackImage->Position->X = 0;
//BackImage->Position->Y = 0;
//BackImage->Scale->X = 100;
//BackImage->Scale->Y = 2;
//BackImage->Bitmap->Resize(Form1->Width*3,Form1->Height*2);
//BackImage->Size->Width = Form1->Width;
//BackImage->Size->Height = Form1->Height;
//BackImage->Scale->X = 2;


Image1->Position->X = 0;
Image1->Position->Y = 0;
Image1->Size->Width = Form1->Width;
Image1->Size->Height = Form1->Height;
Image1->BringToFront();

BackImage = new TImage(Form1);
BackImage->Parent = Form1;
BackImage->Bitmap->LoadFromFile("black.png");
BackImage->Position->X = 0;
BackImage->Position->Y = 0;
BackImage->Width = BackImage->Bitmap->Width;
BackImage->Height = BackImage->Bitmap->Height;
BackImage->Bitmap->Resize(BackImage->Bitmap->Width*10,BackImage->Bitmap->Height*10);
BackImage->Width = BackImage->Bitmap->Width;
BackImage->Height = BackImage->Bitmap->Height;
BackImage->SendToBack();
BackImage->Opacity = 1;

//TBrushKind s;
//TBrush* Brush = new TBrush(TBrushKind::Solid,0xff000000);
//BackImage->Canvas->FillRect(TRectF(TPointF(0,0),Form1->Width,Form1->Height),1000.0,1000.0,TCorners(),1.0,Brush,TCornerType::Round);

//for (int i=0; i < 100; i++) {
//  Images[i]->Bitmap->LoadFromFile("c:\\Quizone\\Quizes\\ThaiKings\\1.png");
//}

//Image1->RotationAngle = 45;
//Image1->Scale->X = 0.5;

Timer1->Enabled = true;

}
//---------------------------------------------------------------------------

void __fastcall TForm1::Timer1Timer(TObject *Sender)
{
TotalWidth = Form1->Width - Images[0]->Bitmap->Width; //1680; //3840;
TQuiz* Quiz = (TQuiz*)MC->QuizControl->GetObject();

if (Quiz->ReloadBG) {
	string str = Quiz->Path;
	str = str + Quiz->BGFilename;
	if (Quiz->BGFilename=="") {
		Quiz->ShowBG = false;
		}
	else
		{
		Image1->Bitmap->LoadFromFile(str.c_str());
		Image1->Bitmap->Resize(Form1->Width,Image1->Bitmap->Height * ((double)Form1->Width/Image1->Bitmap->Width));
		Image1->Size->Width = Form1->Width;
		Image1->Size->Height = Image1->Bitmap->Height;
		Quiz->ReloadBG = false;
		}
	}

if (Quiz->ReloadFrame) {
	string str = Quiz->Path;
	str = str + Quiz->FrameFileName;
	if (Quiz->FrameFileName=="") {
		Quiz->ShowFrame = false;
		}
	else
		{
		for (int i=0; i < Quiz->NumItems; i++)
			{
			ImagesFrame[i]->Bitmap->LoadFromFile(str.c_str());
			double ScaleX = Quiz->Items[i].SizeX;
			double ScaleY = Quiz->Items[i].SizeY;
			ImagesFrame[i]->Bitmap->Resize(ImagesFrame[i]->Bitmap->Width * ScaleX  ,ImagesFrame[i]->Bitmap->Height * ScaleY);
			ImagesFrame[i]->Size->Width = ImagesFrame[i]->Bitmap->Width * ScaleX;
			ImagesFrame[i]->Size->Height = ImagesFrame[i]->Bitmap->Height * ScaleY;

			ImagesShadow[i]->Bitmap->LoadFromFile(str.c_str());
			ImagesShadow[i]->Bitmap->Resize(ImagesShadow[i]->Bitmap->Width * ScaleX  ,ImagesShadow[i]->Bitmap->Height * ScaleY);
			ImagesShadow[i]->Size->Width = ImagesShadow[i]->Bitmap->Width * ScaleX;
			ImagesShadow[i]->Size->Height = ImagesShadow[i]->Bitmap->Height * ScaleY;
			int X, Y;
			TBitmapData bm;
			if (ImagesShadow[i]->Bitmap->Map(TMapAccess::maReadWrite, bm) )
			for (X = 0; X < ImagesShadow[i]->Bitmap->Width; X++)
			{
				for (Y = 0; Y < ImagesShadow[i]->Bitmap->Height; Y++)
				{
				if (bm.GetPixel(X,Y) > 0)
				bm.SetPixel(X, Y, claBlack);
				}
			}
			ImagesShadow[i]->Bitmap->Unmap(bm);
			}
		Quiz->ReloadFrame = false;
		//MediaPlayerControl1->BringToFront();
		//MediaPlayerControl1->Visible = true;
		//MediaPlayerControl1->Width = 500;
		//MediaPlayerControl1->Height = 500;
		//MediaPlayerControl1->Position->X = 500;
		//MediaPlayerControl1->Position->Y = 500;
		//MediaPlayer1->Play();
		}
	}


for (int i=0; i < Quiz->NumItems; i++) {
		if (Quiz->Items[i].Reload) {
			string str = Quiz->Path;
			str = str + Quiz->Items[i].FileName;
		  //  Images[i]->Bitmap->Clear(0);
		 //	Images[i]->Bitmap->FreeHandle();
		//	Images[i]->Bitmap->Resize(100,100);
		try{
			Images[i]->Bitmap->LoadFromFile(str.c_str());
			double ScaleX = Quiz->Items[i].SizeX;
			double ScaleY = Quiz->Items[i].SizeY;

			Images[i]->Bitmap->Resize(Images[i]->Bitmap->Width * ScaleX,Images[i]->Bitmap->Height * ScaleY);
			Images[i]->Size->Width = Images[i]->Bitmap->Width * ScaleX;
			Images[i]->Size->Height = Images[i]->Bitmap->Height * ScaleY;

			ImagesShadow[i]->BringToFront();
			ImagesFrame[i]->BringToFront();
			Images[i]->BringToFront();
								 // for some reason if you change the conseqence, itemslabels sometimes does not appear...
			Labels[i]->BringToFront();
			ItemLabels[i]->BringToFront();



			Quiz->Items[i].Reload = false;
			}
			catch(...)
				{
					int t=1;
				}

			}
		}



static TCommand *Command=NULL;
int Code;
string Msg;

	while (MC->ReportCommands->GetResult(Command))
	 {
	if (Command->GetResult(&Code,&Msg))
		{
		if (Command->GetResult(&Code,&Msg))
			{
			if (InsertLog)
			{
			//if (Code!=COMMAND::SUCCESS) {
			//Memo1->Lines->Add(Msg.c_str());
			//}
			Memo2->Lines->Add(Msg.c_str());
			Memo2->Lines->Add(Command->GetCommandString().c_str());
			}
			}
		}
	 }

while (MC->UICommands->GetCommand(Command))
	{
	if (Command->GetCommandName()=="Msg") {
		if (Command->GetParamCount()>0) {
		  //	if (Command->Param(0)->IsNumber())
		  //	   ShowMessage((AnsiString)Command->Param(0)->GetAsNumber());
		  //	else
			   ShowMessage((AnsiString)Command->Param(0)->GetAsString().c_str());
			Command->InsertResult(COMMAND::SUCCESS,COMMAND::CommandErrorString[COMMAND::SUCCESS]);
			}
		else
		Command->InsertResult(COMMAND::TOO_FEW_PARAMETERS,COMMAND::CommandErrorString[COMMAND::TOO_FEW_PARAMETERS]);
		}
	if (Command->GetCommandName()=="Send") {
		if (Command->GetParamCount()>0) {
				TByteDynArray A;
				string s = Command->Param(0)->GetAsString();
				A.set_length(s.length());
				for (int i=0; i < s.length(); i++) {
					A[i]=s[i];
					}
				IdUDPClient1->SendBuffer(A);
			Command->InsertResult(COMMAND::SUCCESS,COMMAND::CommandErrorString[COMMAND::SUCCESS]);
			}
		}
	}


Image1->Opacity = Quiz->BGOpacity;
BackImage->Opacity = Quiz->BGBlackOpacity;

for (int i=Quiz->NumItems; i < 55; i++) {
	Images[i]->Opacity = 0; // Bitmap->Clear(0);
	Labels[i]->Opacity = 0;
	ItemLabels[i]->Opacity = 0;
	}

for (int i=0; i < Quiz->NumItems; i++) {

	double SpeedX = MotionsX[i].GetSpeed(Timer1->Interval/1000.0);
	double SpeedY = MotionsY[i].GetSpeed(Timer1->Interval/1000.0);

	LastX[i] = MotionsX[i].GetPosition(Timer1->Interval/1000.0);
	LastY[i] = MotionsY[i].GetPosition(Timer1->Interval/1000.0);

	MotionsX[i].SetTargetDuration(LastX[i],0,Quiz->Items[i].PosX,SpeedX,Quiz->TransitionTime,Quiz->Acc,false);
	MotionsY[i].SetTargetDuration(LastY[i],0,Quiz->Items[i].PosY,SpeedY,Quiz->TransitionTime,Quiz->Acc,false);

	double X = MotionsX[i].GetPosition(Timer1->Interval/1000.0);
	double Y = MotionsY[i].GetPosition(Timer1->Interval/1000.0);



	Images[i]->Scale->X = 1;// Quiz->Items[i].SizeX * Quiz->Items[i].Scale;
	Images[i]->Scale->Y = 1; //Quiz->Items[i].SizeY * Quiz->Items[i].Scale;
	Images[i]->Position->X = X * TotalWidth;
	Images[i]->Position->Y = (ImagesFrame[i]->Height - Images[i]->Height)/2 + Y * Form1->Height;
	Images[i]->Opacity = Quiz->Items[i].Image.Opacity.GetCurrent();

	ImagesFrame[i]->Scale->X = Images[i]->Scale->X;
	ImagesFrame[i]->Scale->Y = Images[i]->Scale->Y;
	ImagesFrame[i]->Position->X = Images[i]->Position->X - (ImagesFrame[i]->Width - Images[i]->Width ) / 2;
	ImagesFrame[i]->Position->Y = Images[i]->Position->Y - (ImagesFrame[i]->Height - Images[i]->Height) / 2;
	ImagesFrame[i]->Opacity = Quiz->ShowFrame ? Images[i]->Opacity : 0;

	if (ImagesFrame[i]->Position->X < 0) { Images[i]->Position->X = Images[i]->Position->X -ImagesFrame[i]->Position->X; ImagesFrame[i]->Position->X = 0;}
	if (ImagesFrame[i]->Position->Y < 0) { Images[i]->Position->Y = Images[i]->Position->Y -ImagesFrame[i]->Position->Y; ImagesFrame[i]->Position->Y = 0;}

	ImagesShadow[i]->Scale->X = ImagesFrame[i]->Scale->X;
	ImagesShadow[i]->Scale->Y = ImagesFrame[i]->Scale->Y;
	ImagesShadow[i]->Position->X =  ImagesFrame[i]->Position->X +15;
	ImagesShadow[i]->Position->Y =  ImagesFrame[i]->Position->Y +15;
	ImagesShadow[i]->Opacity = Quiz->ShowFrame ? Images[i]->Opacity /1.5 : 0.75;

	ItemLabels[i]->Position->X = Images[i]->Position->X + Quiz->Items[i].Label.PosX.GetCurrent();
	ItemLabels[i]->Position->Y = Images[i]->Position->Y + Quiz->Items[i].Label.PosY.GetCurrent();

	Labels[i]->Scale->X = 5* Images[i]->Scale->X;
	Labels[i]->Scale->Y = 5* Images[i]->Scale->Y;

	ItemLabels[i]->Scale->X = Quiz->Items[i].Label.ScaleX.GetCurrent();
	ItemLabels[i]->Scale->Y = Quiz->Items[i].Label.ScaleY.GetCurrent();

	ItemLabels[i]->Text = Quiz->Items[i].Label.Caption.c_str();
	if (ItemLabels[i]->Text!="") {
		int t=1;
		}

	//Label1->StyledSettings = Label1->StyledSettings << TStyledSetting::FontColor;
	//Label1->FontColor = claCrimson;
	//Label1->StyledSettings-> Settings->StyledSettings = Settings->StyledSettings >> TStyledSetting::ssFontColor;
	//Label1->TextSettings->FontColor = 0xff5511;


	Labels[i]->StyledSettings = Labels[i]->StyledSettings >> TStyledSetting::ssFontColor;
	Labels[i]->TextSettings->FontColor = Quiz->Items[i].LabelColor;

	ItemLabels[i]->StyledSettings = ItemLabels[i]->StyledSettings >> TStyledSetting::ssFontColor;
  	ItemLabels[i]->TextSettings->FontColor =  Quiz->Items[i].Label.Color;

  //	ItemLabels[i]->StyledSettings = ItemLabels[i]->StyledSettings >> TStyledSetting::ssSize;
  //	ItemLabels[i]->TextSettings->Font->Size = 18;

	//if (Quiz->Items[i].Label.Color.c_str()!="") ItemLabels[i]->TextSettings->FontColor = StrToInt(Quiz->Items[i].Label.Color.c_str());
	//ItemLabels[i]->TextSettings->FontColor = 0xffee8822;
	ItemLabels[i]->Opacity = Quiz->Items[i].Label.Opacity.GetCurrent();
	if (ItemLabels[i]->Opacity>0) {
		int u=1;
		}

	//Labels[i]->FontColor = 0xaa5511;
	Labels[i]->Text = i+1;
	int TextLength = Labels[i]->Text.Length();

	Labels[i]->Position->X = Images[i]->Position->X + (Images[i]->Size->Width) /2.0 - TextLength * 4 * Labels[i]->Scale->X;
	Labels[i]->Position->Y = Images[i]->Position->Y + (Images[i]->Size->Height) - (Labels[i]->Height - Quiz->Items[i].LabelsYOffset) /2 * Labels[i]->Scale->Y / 2;

	if (Quiz->Items[i].AddNumber == true) {
					 Labels[i]->Opacity = 0.8 * Images[i]->Opacity ;
		}
	else
		{
			Labels[i]->Opacity = 0.0;
		}
MainLabel->Opacity = Quiz->LabelOpacity;
MainLabel->Text = Quiz->Label.c_str();
MainLabel->Scale->X = 10;
MainLabel->Scale->Y = 10;
MainLabel->StyledSettings = MainLabel->StyledSettings >> TStyledSetting::ssFontColor;
MainLabel->TextSettings->FontColor = 0xffffffff;
//int t =MainLabel->Canvas->Width;
 //t =MainLabel->Canvas->TextWidth();
int t1 =MainLabel->Canvas->TextWidth(MainLabel->Text);
int t2 =MainLabel->Canvas->TextHeight(MainLabel->Text);

MainLabel->Position->X = Form1->Width/2 - t1*10/2;
MainLabel->Position->Y = Form1->Height/2 - t2*10/2;


//ItemLabels[i]->Position->X = 500;
//ItemLabels[i]->Position->Y = 100;
//ItemLabels[1]->Scale->X = 10;//ItemLabels[i]->Scale->X; //1 * Quiz->Items[i].Label.ScaleX.GetCurrent(); ;//ItemLabels[i]->Scale->X;
//ItemLabels[1]->Scale->Y = 10;//ItemLabels[i]->Scale->Y; //1;//ItemLabels[i]->Scale->X; //10;//ItemLabels[i]->Scale->X;
//ItemLabels[i]->Scale->X = 10;
//ItemLabels[1]->Opacity = 1;
//ItemLabels[1]->Text = "asdfadsf";
//ItemLabels[i]->TextSettings->FontColor = 0xffee8822;
	}
}

//---------------------------------------------------------------------------

void __fastcall TForm1::FormKeyDown(TObject *Sender, WORD &Key, System::WideChar &KeyChar,
		  TShiftState Shift)
{
static double SizeX = 1;
static int ScriptId = 1;
if (Key==39) {
	MC->Commands->CreateCommand("Script.StopScript,RotateQuizId");
	MC->Commands->CreateCommand("Script.RunScript,RotateQuizId");




  //	ScriptId++;
  //	char str[255];
  //	sprintf(str,"Script.RunScript,%d",ScriptId);
  //	MC->Commands->CreateCommand(str);
}
if (Key==37) {
  //	ScriptId--;
  //	char str[255];
  //	sprintf(str,"Script.RunScript,%d",ScriptId);
  //	MC->Commands->CreateCommand(str);
}

if ((KeyChar>='1') && (KeyChar<='9'))
	{
	MC->Commands->CreateCommand("Script.StopScript,RotateQuizId");
    char str[255];
	sprintf(str,"Script.Set,CurrentQuiz,%d",KeyChar-49);
	MC->Commands->CreateCommand(str);
	MC->Commands->CreateCommand("Script.RunScript,RotateQuizId");
	}

if (KeyChar=='a')
	{
	SizeX = SizeX + 0.1;
	char str[255];
	sprintf(str,"LoadImage,0,\"Egypt.png\",%f,%f",SizeX,SizeX);
	MC->QuizCommands->CreateCommand(str);
	}
if (KeyChar=='q')
	{
	SizeX = SizeX - 0.1;
	char str[255];
	sprintf(str,"LoadImage,0,\"Egypt.png\",%f,%f",SizeX,SizeX);
	MC->QuizCommands->CreateCommand(str);
	}
if (KeyChar=='r')
	{
	MC->QuizCommands->CreateCommand("Quiz.Randomize");
	}
if (Key==27) // escape
	{
	MC->QuizControl->Stop();
	MC->QueryControl->Stop();
	MC->ScriptControl->Stop();
	MC->Stop();
	Sleep(2500);
	Form1->Close();
	Application-> Terminate();
	}


}

//---------------------------------------------------------------------------



void __fastcall TForm1::IdUDPServer1UDPRead(TIdUDPListenerThread *AThread, const TIdBytes AData,
          TIdSocketHandle *ABinding)
{
ProcessString(AData,COMMAND::SOURCE_UDP);
}
//---------------------------------------------------------------------------

void TForm1::ProcessString(TIdBytes AData, int Source)
{
string Str;
bool IsHeader = false;
int i=0;
int CommandStart;
int CommandEnd;
while (i < AData.get_length()-1)
	{
	Str = "";
	CommandStart=i;
	CommandEnd = i-1;
	if ((AData[i]==0x02) && (AData[i+1]==',')) {
		IsHeader=true;
		CommandStart = i+2;
		int j=CommandStart;
		while (j <AData.get_length()-1) {
			if ((AData[j]==0x03) && (AData[j+1]==0x00)) {
				CommandEnd = j;
				break;
				}
			j++;
			}
		if (CommandEnd<CommandStart) {
				return;		// wrong tailer
			}
		}
	else   {
		IsHeader = false;
		}
		if (IsHeader==true) {
			for (int k=CommandStart;k<CommandEnd;k++)
				Str = Str + char(AData[k]);
			}
		else{
			for (int k=i;k<AData.get_length();k++)
				Str = Str + char(AData[k]);
			}

		CMD->CreateCommand(Str,0,COMMAND::SOURCE_UDP);
		if (IsHeader==true)
			i=i+2+CommandEnd;
		else
			break;
	}

}

void __fastcall TForm1::FormClose(TObject *Sender, TCloseAction &Action)
{
Application-> Terminate();
return;

	MC->QuizControl->Stop();
	MC->QueryControl->Stop();
	MC->ScriptControl->Stop();
	MC->Stop();
	Sleep(1000);
	Form1->Close();
	Application-> Terminate();
}
//---------------------------------------------------------------------------


void __fastcall TForm1::Image1DblClick(TObject *Sender)
{
Panel1->Visible = true;
Panel1->BringToFront();
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Image1Click(TObject *Sender)
{
Panel1->Visible = false;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Panel1MouseDown(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  float X, float Y)
{
PanelIsPressed = true;
PanelStartX = X;
PanelStartY = Y;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Panel1MouseUp(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  float X, float Y)
{
PanelIsPressed = false;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Panel1MouseMove(TObject *Sender, TShiftState Shift, float X,
		  float Y)
{
if (PanelIsPressed) {
	Panel1->Position->X = Panel1->Position->X - (PanelStartX -X);
	Panel1->Position->Y = Panel1->Position->Y - (PanelStartY -Y);
	}
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Image1MouseMove(TObject *Sender, TShiftState Shift, float X,
		  float Y)
{
if (PanelIsPressed) {
	Panel1->Position->X = (X - PanelStartX );
	Panel1->Position->Y = (Y - PanelStartY);
	}
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Image1MouseUp(TObject *Sender, TMouseButton Button, TShiftState Shift,
          float X, float Y)
{
PanelIsPressed = false;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::CheckBox3Change(TObject *Sender)
{
InsertLog = CheckBox3->IsChecked;
}
//---------------------------------------------------------------------------

void __fastcall TForm1::Edit1KeyDown(TObject *Sender, WORD &Key, System::WideChar &KeyChar,
		  TShiftState Shift)
{
if (Key==13) {
	//char str[255];
	//sprintf(str,"Script.RunScript,%d",ScriptId);
   //	UnicodeString stt = Edit1->Text;
   //stt.
   //	AnsiString str = (AnsiString)stt;
	//string strr = stt. .c_str();
	MC->Commands->CreateCommand((AnsiString(Edit1->Text)).c_str());
	}
}
//---------------------------------------------------------------------------





